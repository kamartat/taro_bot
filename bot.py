import os
import logging
from datetime import date

from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import (
    ReplyKeyboardMarkup,
    KeyboardButton,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
)
from dotenv import load_dotenv

import openai
from apscheduler.schedulers.asyncio import AsyncIOScheduler

# -------------------------------------------------------
# –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø
# -------------------------------------------------------
logging.basicConfig(level=logging.INFO)

# -------------------------------------------------------
# –ó–ê–ì–†–£–ó–ö–ê –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø
# -------------------------------------------------------
load_dotenv()
BOT_TOKEN = os.getenv("BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env")
if not OPENAI_API_KEY:
    raise RuntimeError("OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env")

openai.api_key = OPENAI_API_KEY

# -------------------------------------------------------
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–û–¢–ê –ò –î–ò–°–ü–ï–¢–ß–ï–†–ê
# -------------------------------------------------------
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)
scheduler = AsyncIOScheduler()

# -------------------------------------------------------
# –¢–ê–†–ò–§–´ –ò –ü–†–û–§–ò–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–ü–û–ö–ê –í –ü–ê–ú–Ø–¢–ò)
# -------------------------------------------------------
TARIFFS = {
    "free": {
        "title": "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø",
        "tarot_per_day": 0,          # 0, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–¥–∏–Ω —Ä–∞—Å–∫–ª–∞–¥ –æ—Ç–¥–µ–ª—å–Ω—ã–π (first_free)
        "numerology_per_day": 0,
        "has_oracle": False,
        "description": (
            "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø:\n"
            "- 1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ –¢–∞—Ä–æ\n"
            "- –î–∞–ª—å—à–µ ‚Äî –ø–æ –ø–ª–∞—Ç–Ω—ã–º —Ç–∞—Ä–∏—Ñ–∞–º\n"
            "- –ë–µ–∑ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏ –∏ –û—Ä–∞–∫—É–ª–∞\n"
        ),
        "price": 0,
    },
    "basic": {
        "title": "–ë–∞–∑–æ–≤—ã–π",
        "tarot_per_day": 3,
        "numerology_per_day": 0,
        "has_oracle": False,
        "description": (
            "–¢–∞—Ä–∏—Ñ ¬´–ë–∞–∑–æ–≤—ã–π¬ª ‚Äî 199 ‚ÇΩ / –º–µ—Å—è—Ü:\n\n"
            "üîÆ –¢–∞—Ä–æ:\n"
            "‚Ä¢ –¥–æ 3 —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –≤ –¥–µ–Ω—å (3 –∫–∞—Ä—Ç—ã: –ø—Ä–æ—à–ª–æ–µ-–Ω–∞—Å—Ç–æ—è—â–µ–µ-–±—É–¥—É—â–µ–µ)\n"
            "‚Ä¢ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ª—é–±–≤–∏, –¥–µ–Ω—å–≥–∞–º, —Å–∏—Ç—É–∞—Ü–∏–∏\n\n"
            "‚ú® –ù—É–º–µ—Ä–æ–ª–æ–≥–∏—è:\n"
            "‚Ä¢ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞—Ä–º–∏—á–µ—Å–∫–æ–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏\n\n"
            "‚òÄÔ∏è –û—Ä–∞–∫—É–ª:\n"
            "‚Ä¢ –±–µ–∑ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –û—Ä–∞–∫—É–ª–∞\n\n"
            "–ü–æ–¥—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã—Ç—è–≥–∏–≤–∞—Ç—å –∫–∞—Ä—Ç—ã."
        ),
        "price": 199,
    },
    "standard": {
        "title": "–°—Ç–∞–Ω–¥–∞—Ä—Ç",
        "tarot_per_day": 5,
        "numerology_per_day": 1,
        "has_oracle": True,
        "description": (
            "–¢–∞—Ä–∏—Ñ ¬´–°—Ç–∞–Ω–¥–∞—Ä—Ç¬ª ‚Äî 299 ‚ÇΩ / –º–µ—Å—è—Ü:\n\n"
            "üîÆ –¢–∞—Ä–æ:\n"
            "‚Ä¢ –¥–æ 5 —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –≤ –¥–µ–Ω—å\n"
            "‚Ä¢ —Ä–∞—Å–∫–ª–∞–¥—ã –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é, –ª—é–±–æ–≤—å, –¥–µ–Ω—å–≥–∏, –≤—ã–±–æ—Ä\n\n"
            "‚ú® –ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—è:\n"
            "‚Ä¢ 1 –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –≤ –¥–µ–Ω—å\n"
            "‚Ä¢ —Ä–∞–∑–±–æ—Ä –∑–∞–¥–∞—á –Ω–∞ 3 –º–µ—Å—è—Ü–∞ –≤–ø–µ—Ä—ë–¥\n\n"
            "‚òÄÔ∏è –£—Ç—Ä–µ–Ω–Ω–∏–π –û—Ä–∞–∫—É–ª:\n"
            "‚Ä¢ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –¥–µ–Ω—å\n"
            "‚Ä¢ –∫–∞—Ä—Ç–∞ –¥–Ω—è, —ç–Ω–µ—Ä–≥–∏—è, —Ñ–∏–Ω–∞–Ω—Å—ã, —Å–æ–≤–µ—Ç, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ\n\n"
            "–≠—Ç–æ —Ä–∞–±–æ—á–∏–π —Ç–∞—Ä–∏—Ñ, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –ø–æ –¥–Ω—é –∏ –ø–æ –±–ª–∏–∂–∞–π—à–∏–º –º–µ—Å—è—Ü–∞–º."
        ),
        "price": 299,
    },
    "premium": {
        "title": "–ü—Ä–µ–º–∏—É–º",
        "tarot_per_day": 10,
        "numerology_per_day": 5,
        "has_oracle": True,
        "description": (
            "–¢–∞—Ä–∏—Ñ ¬´–ü—Ä–µ–º–∏—É–º¬ª ‚Äî 499 ‚ÇΩ / –º–µ—Å—è—Ü:\n\n"
            "üîÆ –¢–∞—Ä–æ:\n"
            "‚Ä¢ –¥–æ 10 —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –≤ –¥–µ–Ω—å\n"
            "‚Ä¢ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã (–¥–æ 5‚Äì7 –∫–∞—Ä—Ç) –ø–æ –∑–∞–ø—Ä–æ—Å—É\n"
            "‚Ä¢ –≥–ª—É–±–∏–Ω–Ω—ã–µ —Ä–∞–∑–±–æ—Ä—ã —Å–∏—Ç—É–∞—Ü–∏–∏, –±–ª–æ–∫–æ–≤, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞\n\n"
            "‚ú® –ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—è:\n"
            "‚Ä¢ –¥–æ 5 –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö —Ä–∞–∑–±–æ—Ä–æ–≤ –≤ –¥–µ–Ω—å\n"
            "‚Ä¢ –∑–∞–¥–∞—á–∏ –¥—É—à–∏, –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ —Ö–≤–æ—Å—Ç—ã, –∞–∫—Ü–µ–Ω—Ç—ã –ø–æ —Å—Ñ–µ—Ä–∞–º\n"
            "‚Ä¢ –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –º–µ—Å—è—Ü–∞ —Å —É–ø–æ—Ä–æ–º –Ω–∞ –∫–∞—Ä–º—É\n\n"
            "‚òÄÔ∏è –£—Ç—Ä–µ–Ω–Ω–∏–π –û—Ä–∞–∫—É–ª:\n"
            "‚Ä¢ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –¥–Ω—è\n"
            "‚Ä¢ —ç–º–æ—Ü–∏–∏, —Å–æ–±—ã—Ç–∏—è, —Ñ–∏–Ω–∞–Ω—Å—ã, —Å–æ–≤–µ—Ç, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ,\n"
            "  —Å–∫—Ä—ã—Ç–∞—è —Å–∏–ª–∞ –∏ —Å–ª–∞–±–æ—Å—Ç—å –¥–Ω—è, —Ü–≤–µ—Ç, —á–∏—Å–ª–æ-–∫–ª—é—á –∏ –º–∞–Ω—Ç—Ä–∞\n\n"
            "–¢–∞—Ä–∏—Ñ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –ø–ª–æ—Ç–Ω–æ–π –º–∞–≥–∏—á–µ—Å–∫–æ–π –∏ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å."
        ),
        "price": 499,
    },
}

# user_profiles[user_id] = {...}
user_profiles = {}

# user_state[user_id] = "tarot" | "numerology" | None
user_state = {}


# -------------------------------------------------------
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# -------------------------------------------------------
def build_main_keyboard() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(
        KeyboardButton("üîÆ –ì–∞–¥–∞–Ω–∏–µ –Ω–∞ –¢–∞—Ä–æ"),
        KeyboardButton("‚ú® –ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—è (3 –º–µ—Å—è—Ü–∞)"),
    )
    kb.add(
        KeyboardButton("‚òÄÔ∏è –£—Ç—Ä–µ–Ω–Ω–∏–π –û—Ä–∞–∫—É–ª –Ω–∞ —Å–µ–≥–æ–¥–Ω—è"),
        KeyboardButton("–¢–∞—Ä–∏—Ñ—ã –∏ –ø–æ–¥–ø–∏—Å–∫–∞"),
    )
    return kb


def get_profile(user_id: int) -> dict:
    """–ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û–±–Ω–æ–≤–ª—è–µ–º –¥–Ω–µ–≤–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏."""
    today = date.today().isoformat()
    profile = user_profiles.get(user_id)
    if profile is None:
        profile = {
            "tariff": "free",
            "first_free_used": False,
            "usage_date": today,
            "tarot_used": 0,
            "numerology_used": 0,
        }
        user_profiles[user_id] = profile
        return profile

    if profile.get("usage_date") != today:
        profile["usage_date"] = today
        profile["tarot_used"] = 0
        profile["numerology_used"] = 0

    return profile


# -------------------------------------------------------
# –ü–†–û–ú–ü–¢–´ –ö OPENAI
# -------------------------------------------------------
async def ask_openai_tarot(question: str) -> str:
    """–†–∞—Å–∫–ª–∞–¥ –¢–∞—Ä–æ –∏–∑ 3 –∫–∞—Ä—Ç (–ø—Ä–æ—à–ª–æ–µ, –Ω–∞—Å—Ç–æ—è—â–µ–µ, –±—É–¥—É—â–µ–µ) —Å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º."""
    system_prompt = (
        "–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ —Å –≥–ª—É–±–æ–∫–∏–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏. "
        "–†–∞–±–æ—Ç–∞–µ—à—å –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, –±–µ–∑ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è —Å–º–µ—Ä—Ç–∏ –∏ –ø—É–≥–∞–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞. "
        "–î–µ–ª–∞–µ—à—å —Ä–∞—Å–∫–ª–∞–¥—ã –∏–∑ —Ç—Ä—ë—Ö –∫–∞—Ä—Ç (–ø—Ä–æ—à–ª–æ–µ, –Ω–∞—Å—Ç–æ—è—â–µ–µ, –±—É–¥—É—â–µ–µ) –∏ –æ–±—ä—è—Å–Ω—è–µ—à—å –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º. "
        "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏."
    )

    user_prompt = (
        f"–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {question}\n\n"
        "–°–¥–µ–ª–∞–π —Ä–∞—Å–∫–ª–∞–¥ –∏–∑ —Ç—Ä—ë—Ö –∫–∞—Ä—Ç –ª—é–±–æ–π –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –∫–æ–ª–æ–¥—ã –¢–∞—Ä–æ:\n"
        "1. –ö–∞—Ä—Ç–∞ –ø—Ä–æ—à–ª–æ–≥–æ\n"
        "2. –ö–∞—Ä—Ç–∞ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ\n"
        "3. –ö–∞—Ä—Ç–∞ –±—É–¥—É—â–µ–≥–æ\n\n"
        "–û–ø–∏—à–∏ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:\n"
        "- –ö—Ä–∞—Ç–∫–æ: –∫–∞–∫–∏–µ –∫–∞—Ä—Ç—ã –≤—ã–ø–∞–ª–∏ (–±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã)\n"
        "- –ü—Ä–æ—à–ª–æ–µ: —á—Ç–æ –ø–æ–≤–ª–∏—è–ª–æ –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é\n"
        "- –ù–∞—Å—Ç–æ—è—â–µ–µ: —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å, —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫–∞ –∏ —Å–∏—Ç—É–∞—Ü–∏–∏\n"
        "- –ë—É–¥—É—â–µ–µ: –∫ —á–µ–º—É –≤—Å—ë –∏–¥—ë—Ç –ø—Ä–∏ —Ç–µ–∫—É—â–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–∏\n"
        "- –ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ —á–µ–ª–æ–≤–µ–∫–∞\n"
        "- –ß—Ç–æ –º–µ—à–∞–µ—Ç (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∏–ª–∏ –≤–Ω–µ—à–Ω–µ–µ)\n"
        "- –°–æ–≤–µ—Ç –¢–∞—Ä–æ: –∫–∞–∫ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é\n\n"
        "–ü–∏—à–∏ –ø–æ –¥–µ–ª—É, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∏–∑–≤–∏–Ω–µ–Ω–∏–π –∏ –±–µ–∑ –∑–∞–ø—É–≥–∏–≤–∞–Ω–∏—è."
    )

    completion = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt},
        ],
        temperature=0.9,
        max_tokens=900,
    )

    return completion.choices[0].message["content"].strip()


async def ask_openai_numerology(birth_data: str) -> str:
    """
    –ö–∞—Ä–º–∏—á–µ—Å–∫–∏–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –º–µ—Å—è—Ü–∞.
    –¢—É—Ç –∞–∫—Ü–µ–Ω—Ç –∏–º–µ–Ω–Ω–æ –Ω–∞ –∫–∞—Ä–º–∏—á–µ—Å–∫–æ–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏ (–∑–∞–¥–∞—á–∏, —Ö–≤–æ—Å—Ç—ã, —É—Ä–æ–∫–∏).
    """
    system_prompt = (
        "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π –Ω—É–º–µ—Ä–æ–ª–æ–≥. "
        "–†–∞–±–æ—Ç–∞–µ—à—å –≤ –¥—É—Ö–µ –∫–∞—Ä–º–∏—á–µ—Å–∫–æ–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏: –∑–∞–¥–∞—á–∏ –¥—É—à–∏, –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ —Ö–≤–æ—Å—Ç—ã, —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–æ–¥–∞. "
        "–û–±—ä—è—Å–Ω—è–µ—à—å –º—è–≥–∫–æ, –±–µ–∑ –∑–∞–ø—É–≥–∏–≤–∞–Ω–∏—è, –¥–∞—ë—à—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. "
        "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏."
    )

    user_prompt = (
        f"–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ (–¥–ª—è –∫–∞—Ä–º–∏—á–µ—Å–∫–æ–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏): {birth_data}\n\n"
        "–°–¥–µ–ª–∞–π –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 3 –º–µ—Å—è—Ü–∞. "
        "–û–ø–∏—Ä–∞–π—Å—è –Ω–∞ –∏–¥–µ—é –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á, —Ö–≤–æ—Å—Ç–æ–≤ –∏ —É—Ä–æ–∫–æ–≤, –Ω–æ –Ω–µ —É–≥–ª—É–±–ª—è–π—Å—è –≤ —Å–ª–æ–∂–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã. "
        "–ù–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.\n\n"
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:\n"
        "1) –û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 3 –º–µ—Å—è—Ü–∞.\n"
        "2) –ú–µ—Å—è—Ü 1:\n"
        "   - –≥–ª–∞–≤–Ω–∞—è –∫–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ –º–µ—Å—è—Ü–∞\n"
        "   - —Ñ–∏–Ω–∞–Ω—Å—ã –∏ —Ä–∞–±–æ—Ç–∞: –∫–∞–∫–∏–µ —É—Ä–æ–∫–∏, —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å\n"
        "   - –ª—é–±–æ–≤—å –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è: —á—Ç–æ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å\n"
        "   - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –∫–∞–∫ –ø—Ä–æ–π—Ç–∏ –º–µ—Å—è—Ü —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ\n\n"
        "3) –ú–µ—Å—è—Ü 2 ‚Äî –ø–æ —Ç–æ–π –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.\n"
        "4) –ú–µ—Å—è—Ü 3 ‚Äî –ø–æ —Ç–æ–π –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.\n\n"
        "5) –ò—Ç–æ–≥: –æ–±—â–∏–π –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç –Ω–∞ 3 –º–µ—Å—è—Ü–∞ ‚Äî 3‚Äì5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.\n\n"
        "–ü–∏—à–∏ –ø–æ –¥–µ–ª—É, –±–µ–∑ –ª–∏—à–Ω–µ–π –º–∏—Å—Ç–∏–∫–∏, —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏."
    )

    completion = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt},
        ],
        temperature=0.9,
        max_tokens=1500,
    )

    return completion.choices[0].message["content"].strip()


async def ask_openai_daily_oracle() -> str:
    """–£—Ç—Ä–µ–Ω–Ω–∏–π –û—Ä–∞–∫—É–ª: –∫–∞—Ä—Ç–∞ –¥–Ω—è, —ç–Ω–µ—Ä–≥–∏—è, —Ñ–∏–Ω–∞–Ω—Å—ã, —Å–æ–≤–µ—Ç, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ —Ç.–¥."""
    system_prompt = (
        "–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ –∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π –Ω—É–º–µ—Ä–æ–ª–æ–≥. "
        "–î–µ–ª–∞–µ—à—å —É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –¥–Ω—è: –∫–∞—Ä—Ç–∞ –¥–Ω—è, —ç–º–æ—Ü–∏–∏, —Å–æ–±—ã—Ç–∏—è, —Ñ–∏–Ω–∞–Ω—Å—ã, —Å–æ–≤–µ—Ç, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, "
        "—Å–∫—Ä—ã—Ç–∞—è —Å–∏–ª–∞ –∏ —Å–ª–∞–±–æ—Å—Ç—å –¥–Ω—è, –ª–∏—á–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (—Ü–≤–µ—Ç, —á–∏—Å–ª–æ-–∫–ª—é—á, –º–∞–Ω—Ç—Ä–∞). "
        "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏."
    )

    user_prompt = (
        "–°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç '–£—Ç—Ä–µ–Ω–Ω–∏–π –û—Ä–∞–∫—É–ª ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:\n"
        "1) –ö–∞—Ä—Ç–∞ –¥–Ω—è: –∫—Ä–∞—Ç–∫–æ, –∫–∞–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è –∏ –∫ —á–µ–º—É –æ–Ω–∞ –≤–µ–¥—ë—Ç.\n"
        "2) –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è.\n"
        "3) –§–∏–Ω–∞–Ω—Å—ã: —á—Ç–æ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ, —á–µ–≥–æ –∏–∑–±–µ–≥–∞—Ç—å.\n"
        "4) –°–æ–≤–µ—Ç –¥–Ω—è: —á—Ç–æ –ª—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å, –Ω–∞ —á—ë–º –¥–µ—Ä–∂–∞—Ç—å —Ñ–æ–∫—É—Å.\n"
        "5) –ß–µ–≥–æ –∏–∑–±–µ–≥–∞—Ç—å: —ç–º–æ—Ü–∏–∏, –¥–µ–π—Å—Ç–≤–∏—è, —Ç–∏–ø –ª—é–¥–µ–π.\n"
        "6) –°–∫—Ä—ã—Ç–∞—è —Å–∏–ª–∞ –¥–Ω—è (–¥–æ–ø. –∫–∞—Ä—Ç–∞) –∏ —Å–∫—Ä—ã—Ç–∞—è —Å–ª–∞–±–æ—Å—Ç—å –¥–Ω—è (–¥–æ–ø. –∫–∞—Ä—Ç–∞).\n"
        "7) –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å—É–¥—å–±—ã ‚Äî 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.\n"
        "8) –õ–∏—á–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —Ü–≤–µ—Ç –¥–Ω—è, —á–∏—Å–ª–æ-–∫–ª—é—á, –º–∞–Ω—Ç—Ä–∞ –¥–Ω—è.\n"
        "–ù–µ –ø–∏—à–∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, —Ç–æ–ª—å–∫–æ —Å–∞–º —Ç–µ–∫—Å—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞."
    )

    completion = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt},
        ],
        temperature=0.9,
        max_tokens=1200,
    )

    return completion.choices[0].message["content"].strip()


# -------------------------------------------------------
# –ï–ñ–ï–î–ù–ï–í–ù–ê–Ø –†–ê–°–°–´–õ–ö–ê –û–†–ê–ö–£–õ–ê (–î–õ–Ø –°–¢–ê–ù–î–ê–†–¢/–ü–†–ï–ú–ò–£–ú)
# -------------------------------------------------------
async def send_daily_oracle():
    logging.info("–ó–∞–ø—É—Å–∫ —É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–∞—Å—Å—ã–ª–∫–∏ –û—Ä–∞–∫—É–ª–∞")
    for user_id, profile in user_profiles.items():
        tariff_key = profile.get("tariff", "free")
        tariff = TARIFFS.get(tariff_key, TARIFFS["free"])
        if not tariff.get("has_oracle"):
            continue

        try:
            text = await ask_openai_daily_oracle()
            await bot.send_message(user_id, text)
        except Exception as e:
            logging.exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –û—Ä–∞–∫—É–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")


async def on_startup(dp: Dispatcher):
    scheduler.add_job(send_daily_oracle, "cron", hour=8, minute=0)
    scheduler.start()
    logging.info("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω")


# -------------------------------------------------------
# –¢–ï–ö–°–¢–´ –ò –ö–ù–û–ü–ö–ò –¢–ê–†–ò–§–û–í
# -------------------------------------------------------
def build_tariff_list_text(profile: dict) -> str:
    current_tariff = profile.get("tariff", "free")

    text = (
        "–¢–∞—Ä–∏—Ñ—ã –∏ –¥–æ—Å—Ç—É–ø:\n\n"
        "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø:\n"
        "- 1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ –¢–∞—Ä–æ\n\n"
        "–ë–∞–∑–æ–≤—ã–π ‚Äî 199 ‚ÇΩ / –º–µ—Å—è—Ü:\n"
        "- –¥–æ 3 —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –¢–∞—Ä–æ –≤ –¥–µ–Ω—å\n"
        "- –±–µ–∑ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏ –∏ –û—Ä–∞–∫—É–ª–∞\n\n"
        "–°—Ç–∞–Ω–¥–∞—Ä—Ç ‚Äî 299 ‚ÇΩ / –º–µ—Å—è—Ü:\n"
        "- –¥–æ 5 —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –¢–∞—Ä–æ –≤ –¥–µ–Ω—å\n"
        "- 1 –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –≤ –¥–µ–Ω—å\n"
        "- –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –£—Ç—Ä–µ–Ω–Ω–∏–π –û—Ä–∞–∫—É–ª\n\n"
        "–ü—Ä–µ–º–∏—É–º ‚Äî 499 ‚ÇΩ / –º–µ—Å—è—Ü:\n"
        "- –¥–æ 10 —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –¢–∞—Ä–æ –≤ –¥–µ–Ω—å\n"
        "- –¥–æ 5 –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö —Ä–∞–∑–±–æ—Ä–æ–≤ –≤ –¥–µ–Ω—å\n"
        "- –¥–µ—Ç–∞–ª—å–Ω—ã–π –£—Ç—Ä–µ–Ω–Ω–∏–π –û—Ä–∞–∫—É–ª –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã\n\n"
        f"–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ: {TARIFFS[current_tariff]['title']}."
    )
    return text


def build_tariff_keyboard() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(
        KeyboardButton("–ü–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ –ë–∞–∑–æ–≤—ã–π 199"),
        KeyboardButton("–ü–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ –°—Ç–∞–Ω–¥–∞—Ä—Ç 299"),
    )
    kb.add(
        KeyboardButton("–ü–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ –ü—Ä–µ–º–∏—É–º 499"),
        KeyboardButton("–ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
    )
    return kb


def build_tariff_buy_keyboard(tariff_key: str) -> InlineKeyboardMarkup:
    tariff = TARIFFS[tariff_key]
    kb = InlineKeyboardMarkup()
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
    # –°–µ–π—á–∞—Å —ç—Ç–æ –∑–∞–≥–ª—É—à–∫–∞: –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞, —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ –∫–Ω–æ–ø–∫–µ
    kb.add(
        InlineKeyboardButton(
            text=f"‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª(–∞) {tariff['price']} ‚ÇΩ ‚Äî –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–∞—Ä–∏—Ñ",
            callback_data=f"buy_{tariff_key}"
        )
    )
    return kb


# -------------------------------------------------------
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
# -------------------------------------------------------
@dp.message_handler(commands=["start"])
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    user_state[user_id] = None
    get_profile(user_id)

    text = (
        "–ü—Ä–∏–≤–µ—Ç. –Ø –±–æ—Ç –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –Ω–∞ –¢–∞—Ä–æ –∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–æ–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏.\n\n"
        "–ü–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥ –¢–∞—Ä–æ –¥–ª—è —Ç–µ–±—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π.\n"
        "–î–∞–ª—å—à–µ ‚Äî –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º.\n\n"
        "–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –º–µ–Ω—é –Ω–∏–∂–µ."
    )
    await message.answer(text, reply_markup=build_main_keyboard())


@dp.callback_query_handler(lambda c: c.data.startswith("buy_"))
async def process_buy_callback(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    profile = get_profile(user_id)
    data = callback_query.data  # buy_basic / buy_standard / buy_premium

    tariff_key = data.replace("buy_", "")
    if tariff_key not in TARIFFS:
        await callback_query.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ.", show_alert=True)
        return

    # –í–ê–ñ–ù–û: –∑–¥–µ—Å—å –ø–æ-—Ö–æ—Ä–æ—à–µ–º—É –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã.
    # –°–µ–π—á–∞—Å –º—ã –ø—Ä–æ—Å—Ç–æ —Å—Ä–∞–∑—É –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–∞—Ä–∏—Ñ.
    profile["tariff"] = tariff_key

    await callback_query.message.answer(
        f"–¢–∞—Ä–∏—Ñ ¬´{TARIFFS[tariff_key]['title']}¬ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.\n"
        "–ú–æ–∂–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –ø–æ –Ω–æ–≤–æ–º—É —É—Ä–æ–≤–Ω—é.",
        reply_markup=build_main_keyboard(),
    )
    await callback_query.answer("–¢–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.")


@dp.message_handler()
async def handle_any_text(message: types.Message):
    user_id = message.from_user.id
    text = message.text.strip()
    profile = get_profile(user_id)

    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    if text == "üîÆ –ì–∞–¥–∞–Ω–∏–µ –Ω–∞ –¢–∞—Ä–æ":
        user_state[user_id] = "tarot"
        await message.answer(
            "–ù–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—é, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é —Å–¥–µ–ª–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥ –∏–∑ —Ç—Ä—ë—Ö –∫–∞—Ä—Ç.\n\n"
            "–¢–≤–æ–π –ø–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥ ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π."
        )
        return

    if text == "‚ú® –ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—è (3 –º–µ—Å—è—Ü–∞)":
        user_state[user_id] = "numerology"
        await message.answer(
            "–ù–∞–ø–∏—à–∏ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä–º–∏—á–µ—Å–∫–æ–≥–æ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ 3 –º–µ—Å—è—Ü–∞.\n"
            "–ú–∏–Ω–∏–º—É–º: –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 19.08.1989).\n"
            "–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è –∏ –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è."
        )
        return

    if text == "‚òÄÔ∏è –£—Ç—Ä–µ–Ω–Ω–∏–π –û—Ä–∞–∫—É–ª –Ω–∞ —Å–µ–≥–æ–¥–Ω—è":
        await message.answer("–°–º–æ—Ç—Ä—é —ç–Ω–µ—Ä–≥–∏–∏ –¥–Ω—è...")
        try:
            result = await ask_openai_daily_oracle()
            await message.answer(result)
        except Exception as e:
            logging.exception(e)
            await message.answer(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ."
            )
        return

    if text == "–¢–∞—Ä–∏—Ñ—ã –∏ –ø–æ–¥–ø–∏—Å–∫–∞":
        tariff_text = build_tariff_list_text(profile)
        await message.answer(tariff_text, reply_markup=build_tariff_keyboard())
        return

    if text == "–ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=build_main_keyboard())
        user_state[user_id] = None
        return

    # –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤ —Å –∫–Ω–æ–ø–∫–æ–π ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª ‚Äî –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å¬ª
    if text == "–ü–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ –ë–∞–∑–æ–≤—ã–π 199":
        await message.answer(
            TARIFFS["basic"]["description"],
            reply_markup=build_main_keyboard(),
        )
        await message.answer(
            "–ï—Å–ª–∏ —Ç–∞—Ä–∏—Ñ —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, –∫–æ–≥–¥–∞ –æ–ø–ª–∞—Ç–∏—à—å:",
            reply_markup=build_tariff_buy_keyboard("basic"),
        )
        return

    if text == "–ü–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ –°—Ç–∞–Ω–¥–∞—Ä—Ç 299":
        await message.answer(
            TARIFFS["standard"]["description"],
            reply_markup=build_main_keyboard(),
        )
        await message.answer(
            "–ï—Å–ª–∏ —Ç–∞—Ä–∏—Ñ —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, –∫–æ–≥–¥–∞ –æ–ø–ª–∞—Ç–∏—à—å:",
            reply_markup=build_tariff_buy_keyboard("standard"),
        )
        return

    if text == "–ü–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ –ü—Ä–µ–º–∏—É–º 499":
        await message.answer(
            TARIFFS["premium"]["description"],
            reply_markup=build_main_keyboard(),
        )
        await message.answer(
            "–ï—Å–ª–∏ —Ç–∞—Ä–∏—Ñ —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, –∫–æ–≥–¥–∞ –æ–ø–ª–∞—Ç–∏—à—å:",
            reply_markup=build_tariff_buy_keyboard("premium"),
        )
        return

    # ----- –†–ï–ñ–ò–ú –¢–ê–†–û -----
    mode = user_state.get(user_id)

    if mode == "tarot":
        # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥
        if profile["tariff"] == "free":
            if not profile.get("first_free_used", False):
                profile["first_free_used"] = True
                await message.answer("–î–µ–ª–∞—é —Ç–≤–æ–π –ø–µ—Ä–≤—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ...")
                try:
                    result = await ask_openai_tarot(text)
                    await message.answer(result)
                except Exception as e:
                    logging.exception(e)
                    await message.answer(
                        "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —è–¥—Ä—É. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ –ø–æ–∑–∂–µ."
                    )
                finally:
                    user_state[user_id] = None
                return
            else:
                await message.answer(
                    "–¢–≤–æ–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ —É–∂–µ –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.\n\n"
                    "–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –ø–æ–¥–∫–ª—é—á–∏ –æ–¥–∏–Ω –∏–∑ —Ç–∞—Ä–∏—Ñ–æ–≤.",
                    reply_markup=build_tariff_keyboard(),
                )
                user_state[user_id] = None
                return

        # –ü–ª–∞—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
        tariff_key = profile.get("tariff", "free")
        tariff = TARIFFS.get(tariff_key, TARIFFS["free"])
        if profile["tarot_used"] >= tariff["tarot_per_day"]:
            await message.answer(
                "–ù–∞ —Å–µ–≥–æ–¥–Ω—è –ª–∏–º–∏—Ç —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –ø–æ —Ç–≤–æ–µ–º—É —Ç–∞—Ä–∏—Ñ—É –∏—Å—á–µ—Ä–ø–∞–Ω.\n"
                "–ú–æ–∂–Ω–æ –ø–æ–≤—ã—Å–∏—Ç—å —Ç–∞—Ä–∏—Ñ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–¢–∞—Ä–∏—Ñ—ã –∏ –ø–æ–¥–ø–∏—Å–∫–∞¬ª.",
                reply_markup=build_tariff_keyboard(),
            )
            user_state[user_id] = None
            return

        profile["tarot_used"] += 1
        await message.answer("–î–µ–ª–∞—é —Ä–∞—Å–∫–ª–∞–¥, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ...")
        try:
            result = await ask_openai_tarot(text)
            await message.answer(result)
        except Exception as e:
            logging.exception(e)
            await message.answer(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —è–¥—Ä—É. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ –ø–æ–∑–∂–µ."
            )
        finally:
            user_state[user_id] = None
        return

    # ----- –†–ï–ñ–ò–ú –ö–ê–†–ú–ò–ß–ï–°–ö–û–ô –ù–£–ú–ï–†–û–õ–û–ì–ò–ò -----
    if mode == "numerology":
        tariff_key = profile.get("tariff", "free")
        tariff = TARIFFS.get(tariff_key, TARIFFS["free"])

        if tariff["numerology_per_day"] <= 0:
            await message.answer(
                "–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–∞—Ä–∏—Ñ–∞—Ö –°—Ç–∞–Ω–¥–∞—Ä—Ç –∏ –ü—Ä–µ–º–∏—É–º.\n"
                "–û—Ç–∫—Ä–æ–π ¬´–¢–∞—Ä–∏—Ñ—ã –∏ –ø–æ–¥–ø–∏—Å–∫–∞¬ª, —á—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç—É–ø.",
                reply_markup=build_tariff_keyboard(),
            )
            user_state[user_id] = None
            return

        if profile["numerology_used"] >= tariff["numerology_per_day"]:
            await message.answer(
                "–ù–∞ —Å–µ–≥–æ–¥–Ω—è –ª–∏–º–∏—Ç –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö —Ä–∞–∑–±–æ—Ä–æ–≤ –ø–æ —Ç–≤–æ–µ–º—É —Ç–∞—Ä–∏—Ñ—É –∏—Å—á–µ—Ä–ø–∞–Ω.\n"
                "–ú–æ–∂–Ω–æ –ø–æ–≤—ã—Å–∏—Ç—å —Ç–∞—Ä–∏—Ñ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–¢–∞—Ä–∏—Ñ—ã –∏ –ø–æ–¥–ø–∏—Å–∫–∞¬ª.",
                reply_markup=build_tariff_keyboard(),
            )
            user_state[user_id] = None
            return

        profile["numerology_used"] += 1
        await message.answer("–°—á–∏—Ç–∞—é —Ç–≤–æ–π –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ...")
        try:
            result = await ask_openai_numerology(text)
            await message.answer(result)
        except Exception as e:
            logging.exception(e)
            await message.answer(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —è–¥—Ä—É. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ –ø–æ–∑–∂–µ."
            )
        finally:
            user_state[user_id] = None
        return

    # –ï—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ –≤—ã–±—Ä–∞–Ω
    await message.answer(
        "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –Ω–∞–∂–º–∏ –æ–¥–Ω—É –∏–∑ –∫–Ω–æ–ø–æ–∫:\n"
        "‚Äî –ì–∞–¥–∞–Ω–∏–µ –Ω–∞ –¢–∞—Ä–æ\n"
        "‚Äî –ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—è (3 –º–µ—Å—è—Ü–∞)\n"
        "‚Äî –£—Ç—Ä–µ–Ω–Ω–∏–π –û—Ä–∞–∫—É–ª –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
        "‚Äî –¢–∞—Ä–∏—Ñ—ã –∏ –ø–æ–¥–ø–∏—Å–∫–∞",
        reply_markup=build_main_keyboard(),
    )


if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True, on_startup=on_startup)
